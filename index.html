<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#667eea" />
  <meta name="description" content="Control de gastos personal con categor√≠as, presupuesto y gr√°ficos" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Gastos Pro" />
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNvbnRyb2wgZGUgR2FzdG9zIFBybyIsCiAgInNob3J0X25hbWUiOiAiR2FzdG9zIFBybyIsCiAgImRlc2NyaXB0aW9uIjogIkNvbnRyb2wgZGUgZ2FzdG9zIHBlcnNvbmFsIGNvbiBjYXRlZ29yw61hcywgcHJlc3VwdWVzdG8geSBncsOhZmljb3MiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzY2N2VlYSIsCiAgInRoZW1lX2NvbG9yIjogIiM2NjdlZWEiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhPVElpSUdobGFXZG9kRDBpTVRreUlqNDhjbVZqZENCM2FXUjBhRDBpTVRreUlpQm9aV2xuYUhROUlqRTVNaUlnWm1sc2JEMGlJelkyTjJWbFlTSXZQanh3WVhSb0lHUTlJazB4TURBZ09UWkRPVEFnT1RZZ09EUWdPRFFnT0RRZ05qaERPRFFnTlRJZ09UQWdOREFnTVRBd0lEUXdRekV4TUNBME1DQXhNVGdnTlRJZ01URTRJRFk0UXpFeE9DQTROQ0F4TVRBZ09UWWdNVEF3SURrMldpSWdabWxzYkQwaUkzZG9hWFJsSWk4K1BIUmxlSFFnZUQwaU9UWWlJSGs5SWpFeU1DSWdabTl1ZEMxemFYcGxQU0kyTUNJZ1ptbHNiRDBpSTNkb2FYUmxJajQ4TDNSbGVIUStQQzl6ZG1jKyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0kxTVRJaUlHaGxhV2RvZEQwaU5URXlJajQ4Y21WamRDQjNhV1IwYUQwaU5URXlJaUJvWldsbmFIUTlJalV4TWlJZ1ptbHNiRDBpSXpZMk4yVmxZU0l2UGp4d1lYUm9JR1E5SWswek1UWWdNalEwUXpJNE1pQXlORFFnTWpVMElESXlPQ0F5TlRRZ01qQXhRekkyTkNBeE56UWdNamd5SURFeU55QXpNVFlnTVRJM1F6TTFNQ0F4TWpjZ016YzBJREUzTkNBek56UWdNakF4UXpNM05DQXlNamdnTXpVd0lESTBOQ0F6TVRZZ01qUTBXaUlnWm1sc2JEMGlJM2RvYVhSbElpOCtQSFJsZUhRZ2VEMGlNalUySWlCNVBTSXpNRFlpSUdadmJuUXRjMmw2WlQwaU1USTRJaUJtYVd4c1BTSWpkMmhwZEdVaVBqdzNJV0ZzYzI4Z1pXMXZhbWtnZEdWNGREND1JaTgrUEhSbGVIUWdlRDBpTWpVMklpQjVQU0l6TnpZaUlHWnZiblF0YzJsNlpUMGlOVFlpSUdacGJHdzlJaU0yTmpkbFpXRWlQand2ZEdWNGRENDhMM04yWno0PSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIj48cmVjdCB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgZmlsbD0iIzY2N2VlYSIvPjxwYXRoIGQ9Ik0xMDAgOTZDOTAgOTYgODQgODQgODQgNjhDODQgNTIgOTAgNDAgMTAwIDQwQzExMCA0MCAxMTggNTIgMTE4IDY4QzExOCA4NCAxMTAgOTYgMTAwIDk2WiIgZmlsbD0iI3doaXRlIi8+PHRleHQgeD0iOTYiIHk9IjEyMCIgZm9udC1zaXplPSI2MCIgZmlsbD0iI3doaXRlIj7wn5KwPC90ZXh0Pjwvc3ZnPg==" />
  <title>Controla tu Money</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-gradient-start: #667eea;
      --bg-gradient-end: #764ba2;
      --container-bg: #ffffff;
      --text-primary: #333;
      --text-secondary: #666;
      --text-muted: #999;
      --border-color: #ddd;
      --input-bg: #ffffff;
      --item-bg: #f8f9fa;
      --shadow: rgba(0,0,0,0.2);
    }

    body.dark-mode {
      --bg-gradient-start: #1a1a2e;
      --bg-gradient-end: #16213e;
      --container-bg: #0f3460;
      --text-primary: #e8e8e8;
      --text-secondary: #b8b8b8;
      --text-muted: #888;
      --border-color: #2a4365;
      --input-bg: #1a365d;
      --item-bg: #1a365d;
      --shadow: rgba(0,0,0,0.5);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      padding: 10px;
      transition: all 0.3s ease;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: var(--container-bg);
      border-radius: 20px;
      box-shadow: 0 10px 40px var(--shadow);
      padding: 15px;
      transition: all 0.3s ease;
    }

    @media (min-width: 480px) {
      body { padding: 20px; }
      .container { padding: 25px; }
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    h1 { color: #667eea; font-size: 20px; }

    @media (min-width: 480px) { h1 { font-size: 24px; } }

    .dark-mode-toggle {
      background: var(--item-bg);
      border: none;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 20px;
      transition: transform 0.2s;
    }

    .dark-mode-toggle:active { transform: scale(0.95); }

    /* NUEVO: subt√≠tulo con mes + periodo */
    .period-title {
      margin: 0 0 15px 0;
      text-align: center;
      font-weight: 800;
      color: var(--text-primary);
      font-size: 13px;
      opacity: 0.95;
    }
    @media (min-width: 480px) {
      .period-title { font-size: 14px; margin: 0 0 18px 0; }
    }

    .editable-section {
      background: var(--item-bg);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    @media (min-width: 480px) {
      .editable-section { padding: 15px; margin-bottom: 20px; }
    }

    .editable-title {
      font-size: 16px;
      font-weight: bold;
      color: var(--text-primary);
      border: none;
      background: transparent;
      width: 100%;
      margin-bottom: 10px;
      padding: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    @media (min-width: 480px) { .editable-title { font-size: 20px; } }

    .editable-title:focus { outline: 2px solid #667eea; border-radius: 5px; }

    .date-inputs { display: flex; gap: 10px; margin-top: 10px; }

    .date-group { flex: 1; }

    .date-group label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }

    .date-group input {
      width: 100%;
      padding: 6px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 13px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .date-group input:disabled {
      opacity: 0.85;
      cursor: not-allowed;
    }

    @media (min-width: 480px) {
      .date-group input { padding: 8px; font-size: 14px; }
    }

    /* NUEVO: acciones fechas */
    .date-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-date {
      border: none;
      border-radius: 10px;
      padding: 9px 12px;
      cursor: pointer;
      font-weight: 800;
      font-size: 13px;
    }

    .btn-date-edit { background: #667eea; color: white; }
    .btn-date-save { background: #4ade80; color: white; }
    .btn-date-cancel { background: #6c757d; color: white; }
    .btn-date:active { transform: scale(0.98); }

    .budget-section {
      background: var(--item-bg);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    @media (min-width: 480px) {
      .budget-section { padding: 15px; margin-bottom: 20px; }
    }

    .budget-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .budget-info { flex: 1; min-width: 0; }

    .budget-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }

    .budget-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--text-primary);
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    @media (min-width: 480px) {
      .budget-label { font-size: 12px; }
      .budget-value { font-size: 22px; }
    }

    .btn-edit-budget {
      background: #667eea;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    @media (min-width: 480px) {
      .btn-edit-budget { padding: 8px 15px; font-size: 13px; }
    }

    .budget-input-wrapper { display: none; margin-bottom: 10px; }
    .budget-input-wrapper.active { display: block; }

    .budget-input-group {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .budget-input-group label {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      min-width: fit-content;
      flex-shrink: 0;
    }

    .budget-input-group input {
      flex: 1;
      min-width: 0;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text-primary);
    }

    @media (min-width: 480px) {
      .budget-input-group label { font-size: 13px; }
      .budget-input-group input { padding: 10px; }
    }

    .budget-buttons { display: flex; gap: 8px; }

    .budget-buttons button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-save-budget { background: #4ade80; color: white; }
    .btn-cancel-budget { background: #6c757d; color: white; }

    @media (min-width: 480px) {
      .budget-buttons button { padding: 10px; font-size: 14px; }
    }

    .budget-bar {
      margin-top: 10px;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }

    .budget-fill {
      height: 100%;
      background: linear-gradient(90deg, #4ade80, #fbbf24, #ef4444);
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .budget-text {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
    }

    .total-display {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 15px;
    }

    .total-label { font-size: 13px; opacity: 0.9; margin-bottom: 5px; }
    .total-amount { font-size: 28px; font-weight: bold; }

    @media (min-width: 480px) {
      .total-display { padding: 20px; margin-bottom: 20px; }
      .total-label { font-size: 14px; }
      .total-amount { font-size: 36px; }
    }

    /* Herramientas */
    .tools {
      background: var(--item-bg);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }
    @media (min-width: 480px) {
      .tools { padding: 15px; margin-bottom: 20px; }
    }
    .tools-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-input {
      flex: 1;
      min-width: 180px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text-primary);
    }
    .mini-btn {
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      background: #667eea;
      color: #fff;
    }
    .mini-btn.secondary {
      background: var(--input-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .mini-btn:active { transform: scale(0.98); }

    /* Resumen */
    .summary-section {
      display: none;
      background: var(--item-bg);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 15px;
    }
    .summary-section.show { display: block; }
    .summary-title {
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 10px;
      text-align: center;
    }
    .summary-list { display: grid; gap: 8px; }
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: var(--container-bg);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }
    .summary-left { display: flex; align-items: center; gap: 8px; min-width: 0; }
    .summary-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .summary-name {
      color: var(--text-primary);
      font-weight: 700;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .summary-value { color: var(--text-primary); font-weight: 800; font-size: 13px; flex-shrink: 0; }

    .chart-container {
      background: var(--item-bg);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .chart-title {
      font-size: 14px;
      font-weight: bold;
      color: var(--text-primary);
      margin-bottom: 15px;
      text-align: center;
    }

    .chart-canvas { max-width: 200px; margin: 0 auto; display: block; }

    @media (min-width: 480px) {
      .chart-container { padding: 20px; margin-bottom: 20px; }
      .chart-title { font-size: 16px; }
      .chart-canvas { max-width: 250px; }
    }

    .category-legend {
      margin-top: 15px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .legend-color { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; }

    @media (min-width: 480px) {
      .category-legend { grid-template-columns: 1fr 1fr; gap: 8px; }
      .legend-item { gap: 8px; font-size: 12px; }
      .legend-color { width: 16px; height: 16px; }
    }

    .add-expense {
      background: var(--container-bg);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 2px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .input-group { margin-bottom: 8px; }

    .input-group input, .input-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 15px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    @media (min-width: 480px) {
      .add-expense { padding: 15px; margin-bottom: 20px; }
      .input-group { margin-bottom: 10px; }
      .input-group input, .input-group select { padding: 12px; font-size: 16px; }
    }

    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .category-select { cursor: pointer; }

    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary { background: #667eea; color: white; }
    .btn-primary:active { transform: scale(0.98); background: #5568d3; }

    .filter-section {
      background: var(--item-bg);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .filter-buttons { display: flex; gap: 6px; flex-wrap: wrap; }

    .filter-btn {
      padding: 7px 12px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      background: var(--input-bg);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    @media (min-width: 480px) {
      .filter-section { padding: 15px; margin-bottom: 20px; }
      .filter-buttons { gap: 8px; }
      .filter-btn { padding: 8px 15px; font-size: 13px; }
    }

    .filter-btn.active { background: #667eea; color: white; border-color: #667eea; }
    .filter-btn:active { transform: scale(0.95); }

    .expenses-list { max-height: 400px; overflow-y: auto; }

    .expense-item {
      background: var(--item-bg);
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      border-left: 4px solid;
      gap: 8px;
    }

    .expense-info { flex: 1; min-width: 0; overflow: hidden; }

    .expense-description {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 3px;
      font-size: 14px;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .expense-category {
      display: inline-block;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-bottom: 3px;
      color: white;
    }

    .expense-date { font-size: 11px; color: var(--text-muted); }

    .expense-amount {
      font-size: 15px;
      font-weight: bold;
      color: #667eea;
      margin-right: 5px;
      flex-shrink: 0;
    }

    .expense-actions { display: flex; gap: 4px; flex-shrink: 0; }

    .btn-edit {
      background: #667eea;
      color: white;
      border: none;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-delete {
      background: #ff4757;
      color: white;
      border: none;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    @media (min-width: 480px) {
      .expense-item { padding: 15px; gap: 10px; }
      .expense-description { font-size: 16px; }
      .expense-category { font-size: 11px; padding: 3px 8px; }
      .expense-date { font-size: 12px; }
      .expense-amount { font-size: 18px; margin-right: 10px; }
      .expense-actions { gap: 5px; }
      .btn-edit, .btn-delete { padding: 8px 12px; font-size: 14px; }
    }

    .btn-edit:active, .btn-delete:active { transform: scale(0.95); }

    .empty-state { text-align: center; color: var(--text-muted); padding: 40px 20px; }

    .btn-clear {
      width: 100%;
      padding: 10px;
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 8px;
      margin-top: 15px;
      cursor: pointer;
      font-size: 14px;
    }

    /* Modal editar */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      padding: 15px;
    }

    .modal.show { display: flex; align-items: center; justify-content: center; }

    .modal-content {
      background: var(--container-bg);
      padding: 20px;
      border-radius: 15px;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      color: var(--text-primary);
      margin-bottom: 15px;
      text-align: center;
    }

    @media (min-width: 480px) {
      .modal { padding: 20px; }
      .modal-content { padding: 25px; }
      .modal-title { font-size: 20px; margin-bottom: 20px; }
    }

    .modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
    .modal-buttons button { flex: 1; }
    .btn-cancel { background: #6c757d; color: white; }

    /* Categor√≠as */
    .category-food { border-left-color: #ff6b6b; }
    .category-transport { border-left-color: #4ecdc4; }
    .category-entertainment { border-left-color: #95e1d3; }
    .category-shopping { border-left-color: #f38181; }
    .category-health { border-left-color: #aa96da; }
    .category-bills { border-left-color: #fcbad3; }
    .category-other { border-left-color: #a8e6cf; }

    .cat-food { background: #ff6b6b; }
    .cat-transport { background: #4ecdc4; }
    .cat-entertainment { background: #95e1d3; }
    .cat-shopping { background: #f38181; }
    .cat-health { background: #aa96da; }
    .cat-bills { background: #fcbad3; }
    .cat-other { background: #a8e6cf; }

    /* Toast */
    .toast-container {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 2000;
      pointer-events: none;
      width: min(420px, calc(100% - 20px));
    }
    .toast {
      pointer-events: none;
      background: rgba(20, 20, 20, 0.92);
      color: white;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.25s ease;
      backdrop-filter: blur(6px);
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: rgba(34, 197, 94, 0.95); }
    .toast.error { background: rgba(239, 68, 68, 0.95); }
    .toast.info { background: rgba(17, 24, 39, 0.92); }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üí∞Controla Tu Moneyüí∞</h1>
      <button class="dark-mode-toggle" onclick="toggleDarkMode()">üåô</button>
    </div>

    <!-- NUEVO: aqu√≠ se pinta Mes + (fechas) -->
    <div class="period-title" id="periodTitle"></div>

    <div class="editable-section">
      <input type="text" class="editable-title" id="monthTitle" placeholder="Mes de gastos..." />

      <div class="date-inputs">
        <div class="date-group">
          <label>Fecha inicio:</label>
          <input type="date" id="startDate" disabled />
        </div>
        <div class="date-group">
          <label>Fecha fin:</label>
          <input type="date" id="endDate" disabled />
        </div>
      </div>

      <div class="date-actions" id="dateActions">
        <button class="btn-date btn-date-edit" id="btnEditDates" onclick="editDates()">‚úèÔ∏è Editar</button>

        <div class="date-actions-edit" id="dateActionsEdit" style="display:none;">
          <button class="btn-date btn-date-cancel" onclick="cancelDatesEdit()">Cancelar</button>
          <button class="btn-date btn-date-save" onclick="saveDates()">Guardar</button>
        </div>
      </div>
    </div>

    <div class="budget-section">
      <div class="budget-display" id="budgetDisplay">
        <div class="budget-info">
          <div class="budget-label">üíµ Presupuesto mensual</div>
          <div class="budget-value" id="budgetDisplayValue">No establecido</div>
        </div>
        <button class="btn-edit-budget" onclick="editBudget()">‚úèÔ∏è Editar</button>
      </div>

      <div class="budget-input-wrapper" id="budgetInputWrapper">
        <div class="budget-input-group">
          <label>üíµ Presupuesto:</label>
          <input type="number" id="budgetAmountInput" placeholder="0.00" step="0.01" />
        </div>
        <div class="budget-buttons">
          <button class="btn-cancel-budget" onclick="cancelBudgetEdit()">Cancelar</button>
          <button class="btn-save-budget" onclick="saveBudget()">Guardar</button>
        </div>
      </div>

      <div class="budget-bar">
        <div class="budget-fill" id="budgetFill"></div>
      </div>
      <div class="budget-text" id="budgetText">Sin presupuesto establecido</div>
    </div>

    <div class="total-display">
      <div class="total-label">Total gastado</div>
      <div class="total-amount" id="totalAmount">‚Ç¨0.00</div>
    </div>

    <div class="tools">
      <div class="tools-row">
        <input id="searchExpenses" class="search-input" type="search" placeholder="üîç Buscar (texto o categor√≠a)" />
        <button class="mini-btn secondary" onclick="toggleSummary()">üìä Resumen</button>
        <button class="mini-btn" onclick="shareExpensesWhatsApp()">üì§ Compartir</button>
      </div>
    </div>

    <div class="summary-section" id="summarySection">
      <div class="summary-title">üìä Resumen por categor√≠a</div>
      <div class="summary-list" id="summaryList"></div>
    </div>

    <div class="chart-container" id="chartContainer" style="display:none;">
      <div class="chart-title">üìä Gastos por Categor√≠a</div>
      <canvas id="expenseChart" class="chart-canvas" width="250" height="250"></canvas>
      <div class="category-legend" id="categoryLegend"></div>
    </div>

    <div class="add-expense">
      <div class="input-group">
        <input type="text" id="expenseDescription" placeholder="Descripci√≥n del gasto" />
      </div>
      <div class="input-group">
        <select id="expenseCategory" class="category-select">
          <option value="food">üçî Comida</option>
          <option value="transport">üöó Transporte</option>
          <option value="entertainment">üéÆ Ocio</option>
          <option value="shopping">üõçÔ∏è Compras</option>
          <option value="health">üíä Salud</option>
          <option value="bills">üìÑ Facturas</option>
          <option value="other">üìå Otros</option>
        </select>
      </div>
      <div class="input-group">
        <input type="number" id="expenseAmount" placeholder="Cantidad (‚Ç¨)" step="0.01" />
      </div>
      <button class="btn btn-primary" onclick="addExpense()">A√±adir Gasto</button>
    </div>

    <div class="filter-section">
      <div class="filter-buttons">
        <button class="filter-btn active" data-category="all" onclick="filterByCategory('all')">Todos</button>
        <button class="filter-btn" data-category="food" onclick="filterByCategory('food')">üçî Comida</button>
        <button class="filter-btn" data-category="transport" onclick="filterByCategory('transport')">üöó Transporte</button>
        <button class="filter-btn" data-category="entertainment" onclick="filterByCategory('entertainment')">üéÆ Ocio</button>
        <button class="filter-btn" data-category="shopping" onclick="filterByCategory('shopping')">üõçÔ∏è Compras</button>
        <button class="filter-btn" data-category="health" onclick="filterByCategory('health')">üíä Salud</button>
        <button class="filter-btn" data-category="bills" onclick="filterByCategory('bills')">üìÑ Facturas</button>
        <button class="filter-btn" data-category="other" onclick="filterByCategory('other')">üìå Otros</button>
      </div>
    </div>

    <div class="expenses-list" id="expensesList">
      <div class="empty-state">No hay gastos registrados</div>
    </div>

    <button class="btn-clear" onclick="clearAllExpenses()">Borrar Todos los Gastos</button>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-title">‚úèÔ∏è Editar Gasto</div>
      <div class="input-group">
        <input type="text" id="editDescription" placeholder="Descripci√≥n del gasto" />
      </div>
      <div class="input-group">
        <select id="editCategory" class="category-select">
          <option value="food">üçî Comida</option>
          <option value="transport">üöó Transporte</option>
          <option value="entertainment">üéÆ Ocio</option>
          <option value="shopping">üõçÔ∏è Compras</option>
          <option value="health">üíä Salud</option>
          <option value="bills">üìÑ Facturas</option>
          <option value="other">üìå Otros</option>
        </select>
      </div>
      <div class="input-group">
        <input type="number" id="editAmount" placeholder="Cantidad (‚Ç¨)" step="0.01" />
      </div>
      <div class="modal-buttons">
        <button class="btn btn-cancel" onclick="closeEditModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveEdit()">Guardar</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    let currentFilter = 'all';
    let editingExpenseId = null;

    // Fechas (modo edici√≥n)
    let datesEditing = false;
    let tempStartDate = null;
    let tempEndDate = null;

    // B√∫squeda
    let searchQuery = '';

    const categoryLabels = {
      food: 'üçî Comida',
      transport: 'üöó Transporte',
      entertainment: 'üéÆ Ocio',
      shopping: 'üõçÔ∏è Compras',
      health: 'üíä Salud',
      bills: 'üìÑ Facturas',
      other: 'üìå Otros'
    };

    const categoryColors = {
      food: '#ff6b6b',
      transport: '#4ecdc4',
      entertainment: '#95e1d3',
      shopping: '#f38181',
      health: '#aa96da',
      bills: '#fcbad3',
      other: '#a8e6cf'
    };

    // Toast
    function toast(message, type = 'info', ms = 1800) {
      const container = document.getElementById('toastContainer');
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.textContent = message;
      container.appendChild(el);

      requestAnimationFrame(() => el.classList.add('show'));

      setTimeout(() => {
        el.classList.remove('show');
        setTimeout(() => el.remove(), 250);
      }, ms);
    }

    // Modo oscuro
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDark);
      document.querySelector('.dark-mode-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      drawChart();
    }

    // Guardar t√≠tulo del mes + actualizar t√≠tulo periodo
    document.getElementById('monthTitle').addEventListener('input', function () {
      localStorage.setItem('monthTitle', this.value);
      updatePeriodTitle();
    });

    // B√∫squeda
    document.getElementById('searchExpenses').addEventListener('input', function () {
      searchQuery = this.value.trim().toLowerCase();
      renderExpenses();
    });

    // Enter para a√±adir
    document.getElementById('expenseAmount').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') addExpense();
    });

    // Modal cerrar click fuera
    document.getElementById('editModal').addEventListener('click', function (e) {
      if (e.target === this) closeEditModal();
    });

    function setDatesInputsEnabled(enabled) {
      document.getElementById('startDate').disabled = !enabled;
      document.getElementById('endDate').disabled = !enabled;
    }

    function isValidRange(start, end) {
      if (!start || !end) return true;
      return new Date(start) <= new Date(end);
    }

    function editDates() {
      datesEditing = true;
      tempStartDate = document.getElementById('startDate').value;
      tempEndDate = document.getElementById('endDate').value;

      setDatesInputsEnabled(true);
      document.getElementById('btnEditDates').style.display = 'none';
      document.getElementById('dateActionsEdit').style.display = 'flex';

      toast('Edita las fechas y pulsa Guardar', 'info', 2000);
    }

    function cancelDatesEdit() {
      datesEditing = false;

      document.getElementById('startDate').value = tempStartDate || '';
      document.getElementById('endDate').value = tempEndDate || '';

      setDatesInputsEnabled(false);
      document.getElementById('btnEditDates').style.display = 'inline-flex';
      document.getElementById('dateActionsEdit').style.display = 'none';

      updatePeriodTitle();
      toast('Cambios cancelados', 'info');
    }

    function saveDates() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;

      if (!start || !end) {
        toast('Selecciona fecha inicio y fin', 'error', 2200);
        return;
      }

      if (!isValidRange(start, end)) {
        toast('La fecha inicio no puede ser posterior a la fecha fin', 'error', 2400);
        return;
      }

      localStorage.setItem('startDate', start);
      localStorage.setItem('endDate', end);

      datesEditing = false;
      setDatesInputsEnabled(false);
      document.getElementById('btnEditDates').style.display = 'inline-flex';
      document.getElementById('dateActionsEdit').style.display = 'none';

      updatePeriodTitle();
      toast('Fechas guardadas ‚úì', 'success');
    }

    function formatISOToES(iso) {
      if (!iso) return '';
      const [y, m, d] = iso.split('-');
      if (!y || !m || !d) return iso;
      return `${d}/${m}/${y}`;
    }

    function updatePeriodTitle() {
      const title = (document.getElementById('monthTitle').value || '').trim();
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;

      const startES = formatISOToES(start);
      const endES = formatISOToES(end);

      const range = (start && end) ? `(${startES} ‚Äì ${endES})` : '';
      const text = [title, range].filter(Boolean).join(' ');

      document.getElementById('periodTitle').textContent = text || '';
    }

    function loadData() {
      // T√≠tulo
      const monthTitle = localStorage.getItem('monthTitle');
      if (monthTitle) {
        document.getElementById('monthTitle').value = monthTitle;
      } else {
        const now = new Date();
        const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        const autoTitle = monthNames[now.getMonth()] + ' ' + now.getFullYear();
        document.getElementById('monthTitle').value = autoTitle;
        localStorage.setItem('monthTitle', autoTitle);
      }

      // Fechas
      const startDate = localStorage.getItem('startDate');
      const endDate = localStorage.getItem('endDate');

      if (startDate) {
        document.getElementById('startDate').value = startDate;
      } else {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const iso = firstDay.toISOString().split('T')[0];
        document.getElementById('startDate').value = iso;
        localStorage.setItem('startDate', iso);
      }

      if (endDate) {
        document.getElementById('endDate').value = endDate;
      } else {
        const now = new Date();
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const iso = lastDay.toISOString().split('T')[0];
        document.getElementById('endDate').value = iso;
        localStorage.setItem('endDate', iso);
      }

      // Dejar bloqueadas hasta Editar
      setDatesInputsEnabled(false);

      // Presupuesto
      updateBudgetDisplay();

      // Pintar t√≠tulo periodo
      updatePeriodTitle();
    }

    function getExpenses() {
      const expenses = localStorage.getItem('expenses');
      return expenses ? JSON.parse(expenses) : [];
    }

    function saveExpenses(expenses) {
      localStorage.setItem('expenses', JSON.stringify(expenses));
    }

    // Presupuesto
    function editBudget() {
      const currentBudget = localStorage.getItem('budget') || '';
      document.getElementById('budgetAmountInput').value = currentBudget;
      document.getElementById('budgetDisplay').style.display = 'none';
      document.getElementById('budgetInputWrapper').classList.add('active');
    }

    function cancelBudgetEdit() {
      document.getElementById('budgetDisplay').style.display = 'flex';
      document.getElementById('budgetInputWrapper').classList.remove('active');
    }

    function saveBudget() {
      const budgetValue = document.getElementById('budgetAmountInput').value;
      localStorage.setItem('budget', budgetValue);
      updateBudgetDisplay();
      updateBudgetBar();
      cancelBudgetEdit();
      toast('Presupuesto guardado ‚úì', 'success');
    }

    function updateBudgetDisplay() {
      const budget = parseFloat(localStorage.getItem('budget')) || 0;
      const displayValue = document.getElementById('budgetDisplayValue');
      if (budget > 0) displayValue.textContent = '‚Ç¨' + budget.toFixed(2);
      else displayValue.textContent = 'No establecido';
    }

    // Gastos
    function addExpense() {
      const description = document.getElementById('expenseDescription').value.trim();
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      const category = document.getElementById('expenseCategory').value;

      if (!description) {
        toast('Introduce una descripci√≥n', 'error', 2200);
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        toast('Introduce una cantidad v√°lida', 'error', 2200);
        return;
      }

      const expense = {
        id: Date.now(),
        description,
        amount,
        category,
        date: new Date().toLocaleString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        })
      };

      const expenses = getExpenses();
      expenses.unshift(expense);
      saveExpenses(expenses);

      document.getElementById('expenseDescription').value = '';
      document.getElementById('expenseAmount').value = '';

      updateTotal();
      updateBudgetBar();
      renderExpenses();
      drawChart();
      renderSummary();

      toast('Gasto guardado ‚úì', 'success');
    }

    function deleteExpense(id) {
      if (confirm('¬øEliminar este gasto?')) {
        let expenses = getExpenses();
        expenses = expenses.filter(exp => exp.id !== id);
        saveExpenses(expenses);

        updateTotal();
        updateBudgetBar();
        renderExpenses();
        drawChart();
        renderSummary();

        toast('Gasto eliminado ‚úì', 'success');
      }
    }

    function openEditModal(id) {
      const expenses = getExpenses();
      const expense = expenses.find(exp => exp.id === id);

      if (expense) {
        editingExpenseId = id;
        document.getElementById('editDescription').value = expense.description;
        document.getElementById('editCategory').value = expense.category;
        document.getElementById('editAmount').value = expense.amount;
        document.getElementById('editModal').classList.add('show');
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      editingExpenseId = null;
    }

    function saveEdit() {
      const description = document.getElementById('editDescription').value.trim();
      const amount = parseFloat(document.getElementById('editAmount').value);
      const category = document.getElementById('editCategory').value;

      if (!description) {
        toast('Introduce una descripci√≥n', 'error', 2200);
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        toast('Introduce una cantidad v√°lida', 'error', 2200);
        return;
      }

      let expenses = getExpenses();
      const index = expenses.findIndex(exp => exp.id === editingExpenseId);

      if (index !== -1) {
        expenses[index].description = description;
        expenses[index].amount = amount;
        expenses[index].category = category;
        saveExpenses(expenses);

        updateTotal();
        updateBudgetBar();
        renderExpenses();
        drawChart();
        renderSummary();

        closeEditModal();
        toast('Gasto actualizado ‚úì', 'success');
      }
    }

    function clearAllExpenses() {
      if (confirm('¬øEst√°s seguro de que quieres borrar TODOS los gastos? Esta acci√≥n no se puede deshacer.')) {
        localStorage.removeItem('expenses');
        updateTotal();
        updateBudgetBar();
        renderExpenses();
        drawChart();
        renderSummary();
        toast('Todos los gastos borrados ‚úì', 'success');
      }
    }

    function filterByCategory(category) {
      currentFilter = category;

      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.category === category) btn.classList.add('active');
      });

      renderExpenses();
    }

    function updateTotal() {
      const expenses = getExpenses();
      const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
      document.getElementById('totalAmount').textContent = '‚Ç¨' + total.toFixed(2);
    }

    function updateBudgetBar() {
      const budget = parseFloat(localStorage.getItem('budget')) || 0;
      const expenses = getExpenses();
      const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);

      if (budget > 0) {
        const percentage = Math.min((total / budget) * 100, 100);
        document.getElementById('budgetFill').style.width = percentage + '%';

        const remaining = budget - total;
        if (remaining >= 0) {
          document.getElementById('budgetText').textContent =
            `Quedan ‚Ç¨${remaining.toFixed(2)} de ‚Ç¨${budget.toFixed(2)}`;
        } else {
          document.getElementById('budgetText').textContent =
            `¬°Presupuesto excedido por ‚Ç¨${Math.abs(remaining).toFixed(2)}!`;
        }
      } else {
        document.getElementById('budgetFill').style.width = '0%';
        document.getElementById('budgetText').textContent = 'Sin presupuesto establecido';
      }
    }

    function renderExpenses() {
      const expenses = getExpenses();
      const listContainer = document.getElementById('expensesList');

      let filtered = expenses;

      if (currentFilter !== 'all') {
        filtered = filtered.filter(exp => exp.category === currentFilter);
      }

      if (searchQuery) {
        filtered = filtered.filter(exp => {
          const d = (exp.description || '').toLowerCase();
          const cLabel = (categoryLabels[exp.category] || exp.category || '').toLowerCase();
          return d.includes(searchQuery) || cLabel.includes(searchQuery) || (exp.category || '').includes(searchQuery);
        });
      }

      if (filtered.length === 0) {
        const msg = searchQuery ? 'No hay resultados para tu b√∫squeda' : 'No hay gastos en esta categor√≠a';
        listContainer.innerHTML = `<div class="empty-state">${msg}</div>`;
        return;
      }

      listContainer.innerHTML = filtered.map(expense => `
        <div class="expense-item category-${expense.category}">
          <div class="expense-info">
            <div class="expense-category cat-${expense.category}">${categoryLabels[expense.category]}</div>
            <div class="expense-description">${expense.description}</div>
            <div class="expense-date">${expense.date}</div>
          </div>
          <div class="expense-amount">‚Ç¨${expense.amount.toFixed(2)}</div>
          <div class="expense-actions">
            <button class="btn-edit" onclick="openEditModal(${expense.id})">‚úèÔ∏è</button>
            <button class="btn-delete" onclick="deleteExpense(${expense.id})">‚úï</button>
          </div>
        </div>
      `).join('');
    }

    function drawChart() {
      const expenses = getExpenses();

      if (expenses.length === 0) {
        document.getElementById('chartContainer').style.display = 'none';
        return;
      }

      const categoryTotals = {};
      expenses.forEach(exp => {
        categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
      });

      if (Object.keys(categoryTotals).length === 0) {
        document.getElementById('chartContainer').style.display = 'none';
        return;
      }

      document.getElementById('chartContainer').style.display = 'block';

      const canvas = document.getElementById('expenseChart');
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 100;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const total = Object.values(categoryTotals).reduce((sum, val) => sum + val, 0);

      let currentAngle = -Math.PI / 2;

      Object.entries(categoryTotals).forEach(([category, amount]) => {
        const sliceAngle = (amount / total) * 2 * Math.PI;

        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = categoryColors[category];
        ctx.fill();

        ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--container-bg');
        ctx.lineWidth = 2;
        ctx.stroke();

        currentAngle += sliceAngle;
      });

      const legendContainer = document.getElementById('categoryLegend');
      legendContainer.innerHTML = Object.entries(categoryTotals).map(([category, amount]) => {
        const percentage = ((amount / total) * 100).toFixed(1);
        return `
          <div class="legend-item">
            <div class="legend-color" style="background: ${categoryColors[category]}"></div>
            <span>${categoryLabels[category]}: ‚Ç¨${amount.toFixed(2)} (${percentage}%)</span>
          </div>
        `;
      }).join('');
    }

    function toggleSummary() {
      const section = document.getElementById('summarySection');
      section.classList.toggle('show');
      if (section.classList.contains('show')) {
        renderSummary();
        toast('Resumen actualizado', 'info');
      }
    }

    function renderSummary() {
      const expenses = getExpenses();
      const totals = {};
      for (const exp of expenses) {
        totals[exp.category] = (totals[exp.category] || 0) + exp.amount;
      }

      const entries = Object.entries(totals).sort((a, b) => b[1] - a[1]);
      const list = document.getElementById('summaryList');

      if (entries.length === 0) {
        list.innerHTML = `<div class="empty-state" style="padding:18px 10px;">No hay datos para resumir</div>`;
        return;
      }

      list.innerHTML = entries.map(([cat, value]) => `
        <div class="summary-item">
          <div class="summary-left">
            <div class="summary-dot" style="background:${categoryColors[cat]}"></div>
            <div class="summary-name">${categoryLabels[cat] || cat}</div>
          </div>
          <div class="summary-value">‚Ç¨${value.toFixed(2)}</div>
        </div>
      `).join('');
    }

    function buildShareText() {
      const title = (document.getElementById('monthTitle').value || 'Gastos').trim();
      const start = document.getElementById('startDate').value || '';
      const end = document.getElementById('endDate').value || '';
      const expenses = getExpenses();

      const total = expenses.reduce((s, e) => s + e.amount, 0);

      const totals = {};
      for (const exp of expenses) totals[exp.category] = (totals[exp.category] || 0) + exp.amount;

      const totalsLines = Object.entries(totals)
        .sort((a, b) => b[1] - a[1])
        .map(([cat, val]) => `- ${categoryLabels[cat] || cat}: ‚Ç¨${val.toFixed(2)}`);

      const topLines = expenses.slice(0, 20).map(exp =>
        `‚Ä¢ ${exp.description} ‚Äî ‚Ç¨${exp.amount.toFixed(2)} (${categoryLabels[exp.category] || exp.category}) [${exp.date}]`
      );

      const rangeLine = (start && end) ? `Periodo: ${start} ‚Üí ${end}` : '';
      const budget = parseFloat(localStorage.getItem('budget')) || 0;
      const budgetLine = budget > 0 ? `Presupuesto: ‚Ç¨${budget.toFixed(2)}` : '';

      const parts = [
        `üìí ${title}`,
        rangeLine,
        budgetLine,
        `üí∞ Total: ‚Ç¨${total.toFixed(2)}`,
        '',
        'üìä Totales por categor√≠a:',
        ...(totalsLines.length ? totalsLines : ['(sin datos)']),
        '',
        `üßæ √öltimos gastos (${Math.min(20, expenses.length)}):`,
        ...(topLines.length ? topLines : ['(sin gastos)'])
      ].filter(Boolean);

      return parts.join('\n');
    }

    async function shareExpensesWhatsApp() {
      const text = buildShareText();

      if (navigator.share) {
        try {
          await navigator.share({ text });
          toast('Lista compartida ‚úì', 'success');
          return;
        } catch (e) {
          // cancelado
        }
      }

      const waUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(waUrl, '_blank');

      try {
        await navigator.clipboard.writeText(text);
        toast('Texto copiado (por si lo necesitas) ‚úì', 'info', 2200);
      } catch {}
    }

    // PWA - Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('data:text/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdnYXN0b3MtcHJvLXYxJzsKY29uc3QgdXJsc1RvQ2FjaGUgPSBbJy4vJ107CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCAoZXZlbnQpID0+IHsKICBldmVudC53YWl0VW50aWwoY2FjaGVzLm9wZW4oQ0FDSEVfTkFNRSkudGhlbigoY2FjaGUpID0+IGNhY2hlLmFkZEFsbCh1cmxzVG9DYWNoZSkpKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgKGV2ZW50KSA9PiB7CiAgZXZlbnQucmVzcG9uZFdpdGgoY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpLnRoZW4oKHJlc3BvbnNlKSA9PiByZXNwb25zZSB8fCBmZXRjaChldmVudC5yZXF1ZXN0KSkpOwp9KTs=')
          .catch(err => console.log('SW registration failed'));
      });
    }

    // PWA - Bot√≥n instalaci√≥n
    let deferredPrompt;
    const installButton = document.createElement('button');
    installButton.textContent = 'üì• Instalar App';
    installButton.className = 'btn-install';
    installButton.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      display: none;
      z-index: 1000;
      font-size: 14px;
    `;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installButton.style.display = 'block';
      document.body.appendChild(installButton);
    });

    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') installButton.style.display = 'none';
        deferredPrompt = null;
      }
    });

    window.addEventListener('appinstalled', () => {
      installButton.style.display = 'none';
      deferredPrompt = null;
    });

    // Init
    window.onload = function () {
      loadData();
      updateTotal();
      updateBudgetBar();
      renderExpenses();
      drawChart();
      renderSummary();

      const darkMode = localStorage.getItem('darkMode');
      if (darkMode === 'true') {
        document.body.classList.add('dark-mode');
        document.querySelector('.dark-mode-toggle').textContent = '‚òÄÔ∏è';
      }
    };
  </script>
</body>
</html>
